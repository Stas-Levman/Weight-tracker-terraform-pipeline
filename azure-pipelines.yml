

# trigger:
# - main

pool: 'self-hosted-stas'

stages:
- stage: Stage_infrastructure
  displayName: Stage infrastructure deploy

  variables: 
  - group: vault secrets - stage

  jobs:
  - deployment: Deploy
    environment: stage
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
            displayName: Clone latest terraform repo
            
          - task: DownloadSecureFile@1
            name: prod_tfvars
            displayName: 'Download prod tfvars file'
            inputs:
              secureFile: 'prod.tfvars'
              
          - script: |
              terraform init
            displayName: Initialzie terraform
            workingDirectory: root_module
            

          - script: |
              terraform workspace select $(Environment.Name)
            displayName: Select workspace
            workingDirectory: root_module
            

          - script: |
              terraform apply -var-file "$(prod_tfvars.secureFilePath)"
            displayName: Deploy infrastructure using .tfvars file
            workingDirectory: root_module
 


- stage: Prod_infrastructure
  displayName: Prod infrastructure deploy

  variables: 
  - group: vault secrets - prod

  jobs:
  - deployment: Deploy
    environment: prod
    strategy:
      runOnce:
        deploy:
          steps:
          - checkout: self
            displayName: Clone latest terraform repo

          - task: DownloadSecureFile@1
            name: prod_tfvars
            displayName: 'Download prod tfvars file'
            inputs:
              secureFile: 'prod.tfvars'
              
            
          - script: |
              terraform init
            displayName: Initialzie terraform
            workingDirectory: root_module

          - script: |
              terraform workspace select $(Environment.Name)
            displayName: Select workspace
            workingDirectory: root_module

          - script: |
              terraform apply -var-file "$(prod_tfvars.secureFilePath)"
            displayName: Deploy infrastructure using .tfvars file
            workingDirectory: root_module

